{
  "projectName": "DrukFarm",
  "description": "A comprehensive agricultural marketplace platform connecting farmers, consumers, transporters, and Tshogpas (cooperative groups) in Bhutan. The system facilitates product listing, ordering, payment workflows, and logistics management with QR code-based order tracking.",
  "version": "1.0.0",
  "repository": {
    "owner": "PemaRinchen-DarkPulse",
    "name": "DrukFarm",
    "currentBranch": "main"
  },
  
  "techStack": {
    "backend": {
      "runtime": "Node.js",
      "framework": "Express.js v4.19.2",
      "database": "MongoDB (Mongoose v8.5.1)",
      "authentication": "bcrypt.js (Password hashing, CID-based auth)",
      "deployment": "Vercel Serverless + Local Development",
      "keyLibraries": [
        "cors v2.8.5 - Cross-origin resource sharing",
        "dotenv v16.4.5 - Environment variable management",
        "morgan v1.10.0 - HTTP request logging",
        "qrcode v1.5.4 - QR code generation for orders",
        "canvas v3.2.0 - Server-side image generation"
      ]
    },
    "frontendWeb": {
      "framework": "React v19.1.1",
      "buildTool": "Vite v7.1.2",
      "routing": "React Router DOM v7.8.1",
      "styling": "Tailwind CSS v4.1.12 + @tailwindcss/vite",
      "uiComponents": "Radix UI (slot), lucide-react icons, class-variance-authority",
      "scanner": "@zxing/browser v0.1.5 - QR/barcode scanning",
      "stateManagement": "React Hooks (useState, useEffect) - No external state library"
    },
    "frontendMobile": {
      "framework": "React Native v0.81.4 (Expo SDK v54.0.0)",
      "navigation": "@react-navigation/native v7.1.17 (Native Stack + Bottom Tabs)",
      "styling": "NativeWind v4.1.23 (Tailwind for React Native)",
      "icons": "@expo/vector-icons v15.0.2, lucide-react-native v0.542.0",
      "camera": "expo-camera v17.0.0 - QR code scanning",
      "imagePicker": "expo-image-picker v17.0.8",
      "qrGeneration": "react-native-qrcode-svg v6.3.3",
      "maps": "react-native-maps v1.20.1",
      "animations": "react-native-reanimated v4.1.2",
      "fileSystem": "expo-file-system v19.0.15, expo-sharing v14.0.0, expo-media-library v18.2.0",
      "stateManagement": "React Hooks + Custom auth context (lib/auth.js)"
    }
  },
  
  "architecture": {
    "pattern": "Monorepo with separate client, mobile, and server applications",
    "structure": {
      "server": "Express.js REST API with MVC-like pattern (routes + models, no explicit controllers)",
      "client": "Vite-powered React SPA with component-based architecture",
      "mobile": "Expo React Native app with screen-based navigation"
    },
    "apiDesign": "RESTful API with JSON payloads",
    "authentication": "Stateless CID-based auth (11-digit Citizen ID). Auth via headers: 'Authorization: CID <11-digit-cid>' or 'x-cid: <cid>'. Password hashing with bcrypt. No JWT tokens.",
    "dataFlow": "Client/Mobile -> Express API -> MongoDB",
    "deploymentModel": {
      "server": "Vercel Serverless Functions (serverless handler in server.js) + Local development support",
      "client": "Static deployment (Vite build)",
      "mobile": "Expo Application Services (EAS) for iOS/Android builds"
    }
  },
  
  "coreModules": {
    "backend": {
      "models": [
        {
          "name": "User",
          "file": "server/models/User.js",
          "purpose": "User accounts with roles (consumer, farmer, transporter, tshogpas)",
          "keyFields": "cid (11 digits, unique), name, password (hashed), role, location, dzongkhag, phoneNumber (8 digits), profileImageData (Buffer), gender",
          "validations": "CID 11 digits, phone 8 digits, strong password (8+ chars, upper, lower, digit, special)",
          "methods": "toJSONSafe() - strips password, converts profileImageData to base64"
        },
        {
          "name": "Product",
          "file": "server/models/Product.js",
          "purpose": "Agricultural products listed by farmers/tshogpas",
          "keyFields": "productName, categoryId (ref Category), description (70-180 chars), price, unit, stockQuantity, productImageData (Buffer), productImageMime, createdBy (CID), rating, reviews",
          "virtuals": "productId (_id), productImageUrl (blob endpoint or legacy URL)",
          "hooks": "capFirst setter for productName/description, pre-update hook for capitalization"
        },
        {
          "name": "Category",
          "file": "server/models/Category.js",
          "purpose": "Product categories with images",
          "keyFields": "categoryName (unique), description (15-45 chars), imageBase64",
          "virtuals": "categoryId (_id)",
          "hooks": "capFirst setter, pre-update capitalization"
        },
        {
          "name": "Order",
          "file": "server/models/Order.js",
          "purpose": "Multi-party order management with 3-step payment flow (consumer -> transporter -> tshogpa -> farmer)",
          "keyFields": "buyer (UserSnapshot), items (array of ProductSnapshot), deliveryAddress (DeliveryAddressSnapshot), status (enum), assignedTransporter (TransporterSnapshotSchema), paymentFlows (PaymentFlowStepSchema), statusHistory, orderQrCode (base64 data URL), orderImageData (Buffer)",
          "paymentFlow": "3-step: consumer_to_transporter -> transporter_to_tshogpa -> tshogpa_to_farmer (with fallback flows for direct transactions)",
          "statusEnum": "pending, confirmed, shipped, in_transit, delivered, cancelled, payment_pending, completed",
          "snapshots": "Captures user, product, address, transporter data at order creation time for immutability"
        },
        {
          "name": "Cart",
          "file": "server/models/Cart.js",
          "purpose": "Shopping cart for consumers",
          "keyFields": "userCid (unique), items (array of { productId, quantity })",
          "constraints": "One cart per user (unique userCid)"
        },
        {
          "name": "Wishlist",
          "file": "server/models/Wishlist.js",
          "purpose": "User wishlist for products",
          "keyFields": "userCid (unique), items (array of productId refs)"
        },
        {
          "name": "Review",
          "file": "server/models/Review.js",
          "purpose": "Product reviews by consumers",
          "keyFields": "productId, orderId, userCid, userName, rating (1-5), title, comment, isEdited, editedAt",
          "constraints": "Unique compound index on (productId, userCid) - one review per user per product",
          "staticMethods": "updateProductStats() - recalculates product rating and review count"
        },
        {
          "name": "Address",
          "file": "server/models/Address.js",
          "purpose": "User delivery addresses",
          "keyFields": "userCid, title, place, dzongkhag, isDefault"
        },
        {
          "name": "DispatchAddress",
          "file": "server/models/DispatchAddress.js",
          "purpose": "Dispatch/pickup locations by dzongkhag and gewog",
          "keyFields": "dzongkhag, gewog, locations (array)"
        },
        {
          "name": "UserDispatchAddress",
          "file": "server/models/UserDispatchAddress.js",
          "purpose": "User-specific dispatch addresses with Tshogpa details",
          "keyFields": "userCid, dzongkhag, gewog, location, tshogpaName, tshogpaPhoneNumber"
        },
        {
          "name": "DropOffLocation",
          "file": "server/models/DropOffLocation.js",
          "purpose": "Drop-off points for orders",
          "keyFields": "name, dzongkhag, coordinates, address, contactNumber"
        }
      ],
      "routes": [
        {
          "path": "/api/users",
          "file": "server/routes/users.js",
          "endpoints": [
            "POST /register - User registration with role selection and validation",
            "POST /login - Login with phoneNumber + password (bcrypt comparison, backward-compatible with plaintext upgrade)",
            "GET / - List all users (with optional filters)",
            "GET /:cid - Get user by CID",
            "PUT /:cid - Update user profile",
            "GET /:cid/image - Get user profile image as binary (image/png or image/jpeg)"
          ]
        },
        {
          "path": "/api/products",
          "file": "server/routes/products.js",
          "endpoints": [
            "GET / - Fetch all products (with filters: cid, includeOwn)",
            "GET /:id - Get product by ID with seller and category details",
            "GET /category/:categoryId - Get products by category",
            "POST / - Create product (requires productImageBase64, converts to Buffer)",
            "PUT /:id - Update product",
            "DELETE /:id - Delete product",
            "GET /:id/image - Serve product image as binary (image/jpeg or image/png)",
            "GET /farmer/:cid - Get products by farmer CID"
          ]
        },
        {
          "path": "/api/categories",
          "file": "server/routes/categories.js",
          "endpoints": [
            "GET / - List all categories",
            "POST / - Create category (requires imageBase64)"
          ]
        },
        {
          "path": "/api/cart",
          "file": "server/routes/cart.js",
          "endpoints": [
            "POST / - Add item to cart (authCid middleware)",
            "GET / - Get user cart (authCid middleware)",
            "PATCH /:itemId - Update cart item quantity",
            "DELETE /:itemId - Remove item from cart"
          ],
          "authentication": "authCid middleware - requires CID in Authorization header or x-cid header"
        },
        {
          "path": "/api/orders",
          "file": "server/routes/orders.js",
          "endpoints": [
            "POST /checkout - Create order from cart with QR generation and order image creation",
            "POST / - Create standalone order",
            "GET / - Get all orders (with filters: buyerCid, sellerCid, transporterCid, status)",
            "GET /my-orders - Get user's orders as buyer",
            "GET /seller-orders - Get orders for seller (farmer/tshogpa)",
            "GET /:orderId - Get order by ID",
            "PUT /:orderId/status - Update order status",
            "POST /:orderId/ship - Mark order as shipped",
            "POST /:orderId/confirm - Mark order as confirmed",
            "GET /:orderId/image - Download order image",
            "POST /:orderId/assign-transporter - Assign transporter to order",
            "POST /:orderId/confirm-farmer-payment - Confirm farmer received payment",
            "GET /:orderId/payment-status - Get payment flow status"
          ],
          "features": [
            "QR code generation with order metadata",
            "Order image generation with Canvas",
            "Atomic stock decrement with rollback on failure",
            "3-step payment flow tracking",
            "Status history with changedBy tracking"
          ]
        },
        {
          "path": "/api/wishlist",
          "file": "server/routes/wishlist.js",
          "endpoints": [
            "POST / - Add product to wishlist",
            "GET /:userCid - Get user wishlist",
            "DELETE /:userCid/:productId - Remove from wishlist"
          ]
        },
        {
          "path": "/api/reviews",
          "file": "server/routes/reviews.js",
          "endpoints": [
            "POST / - Create review",
            "GET /product/:productId - Get product reviews",
            "PUT /:reviewId - Update review",
            "DELETE /:reviewId - Delete review"
          ]
        },
        {
          "path": "/api/addresses",
          "file": "server/routes/addresses.js",
          "endpoints": [
            "GET /:userCid - Get user addresses",
            "POST / - Create address",
            "PUT /:id - Update address",
            "DELETE /:id - Delete address",
            "PUT /:id/default - Set default address"
          ]
        },
        {
          "path": "/api/dispatch-addresses",
          "file": "server/routes/dispatch-addresses.js",
          "endpoints": [
            "POST / - Create dispatch address",
            "GET / - Get all dispatch addresses",
            "GET /:dzongkhag - Get by dzongkhag",
            "GET /:dzongkhag/:gewog - Get by dzongkhag and gewog"
          ]
        },
        {
          "path": "/api/user-dispatch-addresses",
          "file": "server/routes/user-dispatch-addresses.js",
          "endpoints": [
            "POST / - Create user dispatch address",
            "GET /:userCid - Get user's dispatch addresses",
            "PUT /:id - Update dispatch address",
            "DELETE /:id - Delete dispatch address"
          ]
        },
        {
          "path": "/api/drop-off-locations",
          "file": "server/routes/drop-off-locations.js",
          "endpoints": [
            "GET / - Get all drop-off locations",
            "GET /dzongkhags - Get unique dzongkhags",
            "GET /dzongkhag/:dzongkhag - Get locations by dzongkhag",
            "GET /:id - Get location by ID",
            "POST / - Create location",
            "PUT /:id - Update location"
          ]
        }
      ],
      "utilities": [
        {
          "file": "server/utils/qr.js",
          "purpose": "QR code generation using qrcode library",
          "exports": "generateQrDataUrl(payload, opts) - Returns base64 data URL"
        },
        {
          "file": "server/utils/image.js",
          "purpose": "Server-side order image generation using Canvas (likely)",
          "exports": "generateOrderImage() - Creates order summary image with QR code"
        }
      ],
      "middleware": [
        {
          "name": "authCid",
          "location": "Inline in routes (cart.js, orders.js)",
          "purpose": "Simple CID-based authentication from headers or body",
          "mechanism": "Extracts CID from 'Authorization: CID <cid>', 'x-cid' header, or req.body.cid. Sets req.user = { cid }"
        }
      ]
    },
    "frontendWeb": {
      "pages": [
        "Home - Landing page with hero, features, testimonials",
        "Login/Register - Authentication flows",
        "Features/Products - Product browsing",
        "Category - Category-based product view",
        "BuyProducts - Shopping interface",
        "Cart - Shopping cart management",
        "Orders - Order history and tracking",
        "Management - Dashboard for farmers/tshogpas (products, orders, profile)",
        "Profile - User profile management",
        "Scanner - QR code scanning for order verification",
        "About, Contact, How - Informational pages"
      ],
      "components": [
        "Navbar - Navigation with role-based menu items",
        "Footer - Site footer",
        "ProductCard - Reusable product display",
        "AddProductModal - Product creation modal",
        "OrderResultModal - Order confirmation display",
        "AuthLayout - Authentication page layout",
        "Hero, Features, Testimonials, CTA - Landing page sections"
      ],
      "lib": [
        {
          "file": "client/src/lib/api.js",
          "purpose": "API client with fetch wrapper",
          "features": "Environment-aware API_BASE (VITE_API_BASE or VITE_BACKEND_URL + /api), request helper with error handling, all CRUD operations for products, categories, cart, orders, wishlist, users"
        },
        {
          "file": "client/src/lib/auth.js",
          "purpose": "Client-side auth utilities",
          "exports": "getCurrentCid() - Extract CID from localStorage/sessionStorage or JWT payload"
        },
        {
          "file": "client/src/lib/utils.js",
          "purpose": "Utility functions (likely Tailwind cn() helper)"
        },
        {
          "file": "client/src/lib/image.js",
          "purpose": "Image handling utilities"
        }
      ],
      "routing": "React Router DOM with BrowserRouter, scroll-to-top on navigation",
      "styling": "Tailwind CSS v4 with custom dark mode, responsive design, shadcn-inspired component patterns"
    },
    "frontendMobile": {
      "screens": [
        "HomePage - Landing/home view",
        "Login/Register - Auth screens (AuthLayout wrapper)",
        "FarmerDashboard - Farmer/Tshogpa/Transporter role-specific dashboard with tabs",
        "Products - Product browsing with filters",
        "Cart - Shopping cart",
        "Checkout - Order placement",
        "MyOrders - Order history",
        "Buy - Purchase flow",
        "Scanner - QR code scanner for order tracking",
        "About, Contact, How - Info screens",
        "Dashboard - Generic dashboard (routes to role-specific view)"
      ],
      "components": [
        "Navbar - Top navigation",
        "BottomDock - Bottom navigation dock",
        "AuthLayout - Auth screen wrapper",
        "ProductCard, ProductDetail - Product components",
        "Category - Category filter",
        "Address, DispatchAddress - Address management",
        "Checkout - Checkout flow component",
        "Wishlist - Wishlist display",
        "TransporterDashboard, TshogpasDashboard - Role-specific dashboards",
        "FarmerFilterModal - Order filtering modal",
        "AddReviewModal - Review submission",
        "EmptyCart, EmptyWishlist - Empty state components",
        "home/*, products/*, setting/*, support/*, ui/* - Feature-grouped components"
      ],
      "lib": [
        {
          "file": "mobile/lib/api.js",
          "purpose": "API client (identical pattern to web client)",
          "features": "Dynamic API_BASE from apiConfig, request wrapper, comprehensive CRUD operations"
        },
        {
          "file": "mobile/lib/apiConfig.js",
          "purpose": "Environment-based API configuration",
          "features": "Switches between API_DEV and API_PROD from expo extra config, isDevelopment() check, logging"
        },
        {
          "file": "mobile/lib/apiInit.js",
          "purpose": "API initialization on app startup",
          "exports": "initializeApi() - Called in App.js useEffect"
        },
        {
          "file": "mobile/lib/auth.js",
          "purpose": "Lightweight auth state management",
          "features": "In-memory user state (_currentUser), listeners for auth changes, useAuth() hook, getCurrentCid() with web storage fallback for Expo web",
          "exports": "setCurrentUser(), getCurrentUser(), onAuthChange(), useAuth(), getCurrentCid()"
        },
        {
          "file": "mobile/lib/image.js",
          "purpose": "Image resolution and handling",
          "exports": "resolveProductImage() - likely"
        },
        {
          "file": "mobile/lib/utils.js",
          "purpose": "Utility functions"
        }
      ],
      "utils": [
        {
          "file": "mobile/utils/imageDownloadSimple.js",
          "purpose": "Image download to gallery with permissions",
          "exports": "downloadOrderImageToGallery(), ensureMediaLibraryImagePermission()"
        },
        {
          "file": "mobile/utils/imageDownload.js",
          "purpose": "Extended image download utilities"
        }
      ],
      "navigation": "React Navigation v7 with Native Stack Navigator, screens wrapped in MainLayout (Navbar + BottomDock), animation: 'none' for instant transitions",
      "styling": "NativeWind (Tailwind for RN) + custom StyleSheet for platform-specific styling"
    }
  },
  
  "environmentVariables": {
    "server": {
      "PORT": "Server port (default: 5000)",
      "MONGODB_URI": "Primary MongoDB connection string (mongodb+srv or mongodb://)",
      "MONGODB_NOSRV_URI": "Fallback non-SRV MongoDB URI for DNS issues",
      "MONGODB_FALLBACK_URI": "Local fallback (default: mongodb://127.0.0.1:27017/drukfarm)",
      "FRONTEND_URL": "Comma-separated allowed CORS origins (default: http://localhost:5173,http://localhost:3000)"
    },
    "client": {
      "VITE_API_BASE": "Full API base URL including /api path",
      "VITE_BACKEND_URL": "Backend origin (dev fallback: http://localhost:5000)",
      "VITE_BACKEND_URL_PROD": "Production backend origin"
    },
    "mobile": {
      "API_DEV": "Development API URL (from app.json extra config, e.g., http://10.24.73.131:5000/api)",
      "API_PROD": "Production API URL (from app.json extra config, e.g., https://druk-farm-backend.vercel.app/api)",
      "ENV": "Environment flag (development/production)"
    }
  },
  
  "userRoles": {
    "consumer": {
      "description": "End users who purchase agricultural products",
      "capabilities": [
        "Browse and search products",
        "Add products to cart and wishlist",
        "Place orders and track delivery",
        "Write reviews and ratings",
        "Manage delivery addresses",
        "Scan QR codes for order verification"
      ]
    },
    "farmer": {
      "description": "Agricultural producers listing and selling products",
      "capabilities": [
        "Create and manage product listings",
        "View and manage incoming orders",
        "Update order status (confirm, ship)",
        "Manage inventory and stock",
        "View sales analytics",
        "Confirm payment receipt",
        "Generate and download order images"
      ]
    },
    "transporter": {
      "description": "Logistics providers handling order delivery",
      "capabilities": [
        "View assigned orders",
        "Update order status (in_transit, delivered)",
        "Scan QR codes to verify orders",
        "Manage dispatch addresses",
        "Track payment flow (consumer to transporter)",
        "View delivery routes and drop-off locations"
      ],
      "legacyNames": ["restaurant", "transported"]
    },
    "tshogpas": {
      "description": "Cooperative groups aggregating farmer products",
      "capabilities": [
        "Manage aggregated product listings from multiple farmers",
        "Process bulk orders",
        "Coordinate with transporters",
        "Manage payment distribution (transporter to tshogpa to farmer)",
        "Set up dispatch addresses and drop-off points",
        "View order analytics and farmer payouts"
      ]
    }
  },
  
  "keyFeatures": {
    "orderManagement": {
      "qrCodeGeneration": "Every order gets a unique QR code (base64 data URL) encoding order metadata for scanning verification",
      "orderImageGeneration": "Server-side Canvas-based image generation with order details and QR code for download/sharing",
      "multiPartyPaymentFlow": "3-step payment tracking: consumer -> transporter -> tshogpa -> farmer with status per step",
      "statusTracking": "Comprehensive status enum (pending, confirmed, shipped, in_transit, delivered, cancelled, payment_pending, completed) with history and changedBy tracking",
      "atomicStockManagement": "Stock decrement with MongoDB $inc atomic operation and rollback on order failure",
      "snapshots": "Immutable snapshots of buyer, products, address, transporter at order creation time"
    },
    "productManagement": {
      "binaryImageStorage": "Products and categories store images as Buffer (productImageData/productImageMime) with backward-compatible base64 support",
      "dynamicImageServing": "Binary image endpoints (e.g., /api/products/:id/image) serve images with proper content-type headers",
      "categorization": "Products linked to categories via categoryId reference",
      "inventoryTracking": "Real-time stock quantity with atomic updates",
      "reviewsAndRatings": "Integrated review system with automatic rating aggregation (updates Product.rating and Product.reviews on review save/delete)"
    },
    "authentication": {
      "cidBasedAuth": "11-digit Bhutanese Citizen ID (CID) as primary identifier instead of email",
      "passwordSecurity": "bcrypt hashing with salt rounds = 10, strong password validation (8+ chars, upper, lower, digit, special)",
      "statelessAuth": "No JWT tokens or sessions; CID passed in headers per request",
      "backwardCompatibility": "Login route auto-upgrades plaintext passwords to bcrypt hash on first login",
      "multiRoleSupport": "Single user schema with role enum, role-based UI/UX differences"
    },
    "geolocation": {
      "dzongkhagSupport": "20 dzongkhags (districts) of Bhutan hardcoded in validation",
      "dispatchAddresses": "Hierarchical dispatch addresses by dzongkhag -> gewog -> location",
      "dropOffLocations": "Geo-coordinated drop-off points with maps integration (react-native-maps)",
      "addressManagement": "Multiple addresses per user with default address flag"
    },
    "mobileSpecific": {
      "qrScanning": "expo-camera for QR code scanning to verify orders",
      "imagePicking": "expo-image-picker for product image uploads",
      "imageDownload": "expo-file-system + expo-media-library for saving order images to gallery",
      "offlineCapability": "Limited (no explicit offline data persistence, relies on API availability)",
      "permissions": "Camera, media library read/write, external storage (Android)"
    }
  },
  
  "dataModels": {
    "relationships": [
      "User (1) -> (N) Product (createdBy CID)",
      "Category (1) -> (N) Product (categoryId ref)",
      "User (1) -> (1) Cart (userCid unique)",
      "User (1) -> (1) Wishlist (userCid unique)",
      "User (1) -> (N) Order (buyer.cid)",
      "Product (N) -> (N) Order (via items array with ProductSnapshot)",
      "User (1) -> (N) Address (userCid)",
      "User (1) -> (N) UserDispatchAddress (userCid)",
      "Product (1) -> (N) Review (productId ref)",
      "Order (1) -> (N) Review (orderId ref)",
      "User (1) -> (N) Review (userCid)"
    ],
    "uniqueConstraints": [
      "User.cid (unique, 11 digits)",
      "User.phoneNumber (unique, 8 digits)",
      "Category.categoryName (unique)",
      "Cart.userCid (unique, one cart per user)",
      "Wishlist.userCid (unique, one wishlist per user)",
      "Review (compound unique: productId + userCid)"
    ]
  },
  
  "codingStyle": {
    "javascript": {
      "convention": "CommonJS for backend (require/module.exports), ES6 modules for frontend (import/export)",
      "linting": "ESLint configured for React (client/mobile), minimal backend linting",
      "formatting": "Prettier with Tailwind plugin for mobile",
      "asyncHandling": "async/await pattern consistently, try/catch with proper error responses",
      "errorHandling": "Centralized error handler in Express app.js, per-route try/catch with descriptive JSON error responses"
    },
    "react": {
      "componentStyle": "Functional components with hooks, no class components",
      "stateManagement": "useState, useEffect, custom hooks (useAuth), no Redux/Zustand",
      "propTypes": "Not used (relying on runtime errors, no TypeScript)",
      "naming": "PascalCase for components, camelCase for functions/variables"
    },
    "database": {
      "schema": "Mongoose schemas with built-in validation, virtuals for computed fields",
      "queries": "Async/await with Mongoose methods (findOne, findOneAndUpdate, etc.)",
      "transactions": "Not explicitly used (relying on atomic operations like $inc)",
      "indexing": "Indexes defined in schema (userCid, cid, compound indexes for reviews)"
    }
  },
  
  "bestPractices": {
    "goodExamples": [
      {
        "practice": "Atomic stock decrement with rollback",
        "location": "server/routes/orders.js - tryDecrementStock() and rollbackStock()",
        "reason": "Prevents race conditions and overselling, ensures data consistency"
      },
      {
        "practice": "Immutable order snapshots",
        "location": "server/models/Order.js - UserSnapshot, ProductSnapshot, etc.",
        "reason": "Preserves order details even if original user/product data changes"
      },
      {
        "practice": "Environment-based API configuration",
        "location": "mobile/lib/apiConfig.js, client/src/lib/api.js",
        "reason": "Clean separation of dev/prod URLs, easy environment switching"
      },
      {
        "practice": "CID validation with regex",
        "location": "All models and routes with CID fields",
        "reason": "Consistent 11-digit CID enforcement across system"
      },
      {
        "practice": "Binary image storage with backward compatibility",
        "location": "server/routes/products.js - mapProduct() function",
        "reason": "Supports both new Buffer storage and legacy base64, smooth migration"
      },
      {
        "practice": "Auto-update product rating on review changes",
        "location": "server/models/Review.js - post-save hook",
        "reason": "Keeps product rating/review count accurate without manual updates"
      },
      {
        "practice": "Centralized API request wrapper",
        "location": "mobile/lib/api.js and client/src/lib/api.js - request() function",
        "reason": "DRY error handling, consistent JSON parsing, single point for headers"
      }
    ],
    "antiPatterns": [
      {
        "pattern": "No authentication tokens/sessions",
        "location": "All API routes",
        "issue": "CID passed in every request header is vulnerable to replay attacks, no refresh mechanism",
        "recommendation": "Implement JWT with refresh tokens or session-based auth for production"
      },
      {
        "pattern": "Plaintext password backward compatibility",
        "location": "server/routes/users.js - login route",
        "issue": "Allows plaintext password comparison and auto-upgrade, security risk if DB is compromised",
        "recommendation": "Remove plaintext fallback, enforce password reset for old accounts"
      },
      {
        "pattern": "Missing error boundary in React",
        "location": "client/src/App.jsx, mobile/App.js",
        "issue": "No global error boundary to catch render errors, app crashes instead of showing error UI",
        "recommendation": "Wrap routes in React Error Boundary component"
      },
      {
        "pattern": "No input sanitization",
        "location": "All POST/PUT routes",
        "issue": "User input not sanitized before DB insertion (potential NoSQL injection, XSS if rendering unsanitized content)",
        "recommendation": "Use express-validator or joi for input validation and sanitization"
      },
      {
        "pattern": "Large inline components",
        "location": "client/src/pages/Management.jsx, mobile/screens/FarmerDashboard.jsx",
        "issue": "700+ line files with mixed concerns (state, UI, API calls), hard to maintain",
        "recommendation": "Extract sub-components, separate business logic into hooks"
      },
      {
        "pattern": "Hardcoded dzongkhag list",
        "location": "server/routes/users.js - validDzongkhags Set",
        "issue": "Hardcoded data in code instead of database collection",
        "recommendation": "Create Dzongkhag model/collection for dynamic management"
      },
      {
        "pattern": "No API rate limiting",
        "location": "server/app.js",
        "issue": "Express app has no rate limiting middleware, vulnerable to DoS attacks",
        "recommendation": "Add express-rate-limit middleware"
      }
    ]
  },
  
  "deployment": {
    "server": {
      "platform": "Vercel Serverless Functions",
      "entryPoint": "server.js (exports handler for serverless, module.main check for local dev)",
      "database": "MongoDB Atlas (inferred from mongodb+srv URIs)",
      "environmentSetup": "Environment variables in Vercel dashboard and .env for local",
      "buildCommand": "None (Node.js runtime handles require)",
      "startCommand": "npm start (runs node server.js for local dev)"
    },
    "client": {
      "platform": "Static hosting (Vercel/Netlify inferred)",
      "buildCommand": "npm run build (Vite build -> dist/ folder)",
      "deploymentTarget": "dist/ folder with static assets",
      "environmentSetup": "VITE_* env vars at build time"
    },
    "mobile": {
      "platform": "Expo Application Services (EAS)",
      "builds": "eas.json configuration for iOS/Android builds",
      "projectId": "f15a4069-339a-4a91-a313-695d8e616d12",
      "owner": "pemarinchen12",
      "bundleId": "com.pemarinchen12.drukfarm (iOS/Android)",
      "sdkVersion": "54.0.0",
      "minSdkVersion": "23 (Android)",
      "targetSdkVersion": "34 (Android)"
    }
  },
  
  "testing": {
    "backend": {
      "framework": "None (no test files found)",
      "utilityScripts": [
        "server/utils/testIntegration.js",
        "server/utils/testPaymentWorkflow.js"
      ]
    },
    "frontend": {
      "framework": "None (no test files found)"
    },
    "recommendation": "Implement unit tests (Jest/Vitest) and integration tests (Supertest for API) for production readiness"
  },
  
  "dependencies": {
    "backend": {
      "production": {
        "bcryptjs": "^2.4.3 - Password hashing",
        "canvas": "^3.2.0 - Server-side image generation",
        "cors": "^2.8.5 - CORS middleware",
        "dotenv": "^16.4.5 - Environment variables",
        "express": "^4.19.2 - Web framework",
        "mongoose": "^8.5.1 - MongoDB ODM",
        "morgan": "^1.10.0 - HTTP logger",
        "qrcode": "^1.5.4 - QR code generation"
      },
      "development": {
        "nodemon": "^3.1.0 - Dev server auto-restart"
      }
    },
    "frontendWeb": {
      "production": {
        "react": "^19.1.1",
        "react-dom": "^19.1.1",
        "react-router-dom": "^7.8.1",
        "tailwindcss": "^4.1.12",
        "@tailwindcss/vite": "^4.1.12",
        "@zxing/browser": "^0.1.5 - Barcode/QR scanning",
        "@radix-ui/react-slot": "^1.2.3 - Component composition",
        "lucide-react": "^0.540.0 - Icons",
        "class-variance-authority": "^0.7.1 - Component variants",
        "clsx": "^2.1.1 - Conditional classes",
        "tailwind-merge": "^3.3.1 - Tailwind class merging"
      },
      "development": {
        "vite": "^7.1.2",
        "@vitejs/plugin-react": "^5.0.0",
        "eslint": "^9.33.0",
        "tw-animate-css": "^1.3.7"
      }
    },
    "frontendMobile": {
      "production": {
        "expo": "~54.0.0",
        "react": "19.1.0",
        "react-native": "0.81.4",
        "@react-navigation/native": "^7.1.17",
        "@react-navigation/native-stack": "^7.3.26",
        "@react-navigation/bottom-tabs": "^7.4.7",
        "nativewind": "^4.1.23",
        "expo-camera": "~17.0.0 - Camera/QR scanning",
        "expo-image-picker": "~17.0.8",
        "expo-file-system": "~19.0.15",
        "expo-media-library": "~18.2.0",
        "expo-sharing": "~14.0.0",
        "react-native-qrcode-svg": "^6.3.3",
        "react-native-maps": "1.20.1",
        "react-native-reanimated": "^4.1.2",
        "lucide-react-native": "^0.542.0",
        "@expo/vector-icons": "^15.0.2"
      },
      "development": {
        "tailwindcss": "3.4.17",
        "prettier-plugin-tailwindcss": "0.5.11"
      }
    }
  },
  
  "futureImprovements": {
    "security": [
      "Implement JWT authentication with refresh tokens",
      "Add API rate limiting (express-rate-limit)",
      "Input validation and sanitization (express-validator/joi)",
      "HTTPS enforcement in production",
      "Content Security Policy headers",
      "Remove plaintext password fallback"
    ],
    "features": [
      "Real-time order status updates (WebSockets/Socket.io)",
      "Push notifications for order updates (Expo push notifications)",
      "Chat system between buyers and sellers",
      "Analytics dashboard for farmers and tshogpas",
      "Multi-language support (Dzongkha/English)",
      "Payment gateway integration (e.g., PayPal, Stripe, local Bhutan payment methods)",
      "AI-based product recommendations",
      "Inventory alerts and low-stock notifications",
      "Bulk order discounts",
      "Order scheduling and recurring orders"
    ],
    "technical": [
      "TypeScript migration for type safety",
      "Unit and integration test coverage (Jest, Supertest)",
      "CI/CD pipeline (GitHub Actions)",
      "Database transactions for complex operations",
      "Caching layer (Redis) for frequently accessed data",
      "Image optimization and CDN (Cloudinary/AWS S3)",
      "Error tracking (Sentry)",
      "Performance monitoring (New Relic/DataDog)",
      "Database backup and disaster recovery strategy",
      "API documentation (Swagger/OpenAPI)"
    ],
    "codeQuality": [
      "Refactor large components into smaller, focused components",
      "Extract business logic into custom hooks and services",
      "Implement React Error Boundaries",
      "Add PropTypes or TypeScript interfaces",
      "Centralize constants (dzongkhags, roles, status enums) into config files",
      "Code splitting and lazy loading for web app",
      "Optimize bundle size (tree shaking, compression)"
    ]
  },
  
  "knownIssues": [
    {
      "issue": "No authentication token expiration",
      "severity": "High",
      "impact": "CID in headers can be reused indefinitely, no logout mechanism",
      "workaround": "Clear CID from client storage on logout"
    },
    {
      "issue": "Potential race condition in stock management",
      "severity": "Medium",
      "impact": "Despite atomic decrement, high concurrency may cause issues without DB transactions",
      "workaround": "tryDecrementStock uses findOneAndUpdate with stock check"
    },
    {
      "issue": "Large base64 images in JSON responses",
      "severity": "Medium",
      "impact": "Product/category endpoints may return large payloads, slow API responses",
      "workaround": "Use binary image endpoints (/api/products/:id/image) where possible"
    },
    {
      "issue": "No pagination on product/order lists",
      "severity": "Low",
      "impact": "Large datasets may cause slow loads and high memory usage",
      "workaround": "Client-side filtering/pagination"
    },
    {
      "issue": "Hardcoded dzongkhag validation",
      "severity": "Low",
      "impact": "Requires code change if dzongkhags change or expand",
      "workaround": "Manual code update"
    }
  ],
  
  "documentation": {
    "readme": "README.md (minimal, backend quick start only)",
    "apiDocs": "None (infer from route files)",
    "componentDocs": "None (no Storybook or JSDoc)",
    "databaseSchema": "Inferred from Mongoose models"
  },
  
  "aiModuleIntegration": {
    "status": "Not Implemented",
    "plannedFeatures": "Product recommendations, demand forecasting, price optimization (mentioned in user tech stack)",
    "framework": "Python (TensorFlow/PyTorch) - No files found in codebase yet"
  },
  
  "notes": [
    "The system uses Bhutanese administrative divisions (dzongkhag, gewog) and CID-based identity, making it culturally specific to Bhutan.",
    "The multi-party payment flow (consumer -> transporter -> tshogpa -> farmer) reflects Bhutan's cooperative agricultural model.",
    "QR code-based order verification is a core feature for reducing fraud and ensuring order authenticity.",
    "The codebase shows signs of rapid development with some technical debt (large components, no tests, missing documentation).",
    "Mobile app uses Expo managed workflow with custom native modules (camera, file system), requiring EAS builds.",
    "Server is designed for both serverless (Vercel) and traditional deployment (local dev with server.listen).",
    "No TypeScript adoption yet, relying on runtime errors and manual type checking.",
    "Authentication is basic (CID-based) and should be upgraded for production security.",
    "Image handling has evolved from legacy base64 strings to Buffer storage with backward compatibility.",
    "The system has comprehensive order lifecycle management with status tracking and payment flow monitoring."
  ]
}
